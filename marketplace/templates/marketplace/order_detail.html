{% extends 'marketplace/base.html' %}

{% block title %}Order #{{ order.id }} - AdEzy{% endblock %}

{% block content %}
<div class="container">
    <div style="max-width: 900px; margin: 40px auto;">
        
        <!-- Order Header -->
        <div class="glass-panel mb-20">
            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 20px;">
                <div>
                    <h2 style="margin-bottom: 10px;">Order #{{ order.id }}</h2>
                    <p style="color: #64748b; margin: 0;">{{ order.gig.title }}</p>
                </div>
                <div style="text-align: right;">
                    <div style="display: inline-block; padding: 8px 16px; background: var(--gold); color: var(--deep-blue); border-radius: 20px; font-weight: 600;">
                        {{ order.get_status_display }}
                    </div>
                </div>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px; padding-top: 20px; border-top: 1px solid var(--light-gray);">
                <div>
                    <p style="color: #64748b; margin: 0 0 5px 0;">Buyer:</p>
                    <p style="font-weight: 600; margin: 0;">{{ order.buyer.username }}</p>
                </div>
                <div>
                    <p style="color: #64748b; margin: 0 0 5px 0;">Seller:</p>
                    <p style="font-weight: 600; margin: 0;">{{ order.seller.username }}</p>
                </div>
                <div>
                    <p style="color: #64748b; margin: 0 0 5px 0;">Price:</p>
                    <p style="font-weight: 600; color: var(--gold); margin: 0;">{{ order.price }} Taka</p>
                </div>
                <div>
                    <p style="color: #64748b; margin: 0 0 5px 0;">Ordered:</p>
                    <p style="font-weight: 600; margin: 0;">{{ order.created_at|date:"M d, Y" }}</p>
                </div>
            </div>

            {% if order.requirements %}
            <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid var(--light-gray);">
                <p style="color: #64748b; margin: 0 0 10px 0;">Requirements:</p>
                <p style="margin: 0;">{{ order.requirements }}</p>
            </div>
            {% endif %}

            <!-- Order Actions for Seller -->
            {% if user == order.seller %}
            <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid var(--light-gray);">
                <p style="color: #64748b; margin: 0 0 10px 0;">Actions:</p>
                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                    {% if order.status == 'pending' %}
                        <button class="btn btn-primary" onclick="updateOrderStatus({{ order.id }}, 'in_progress')">
                            Accept Order
                        </button>
                        <button class="btn btn-secondary" onclick="updateOrderStatus({{ order.id }}, 'cancelled')">
                            Decline
                        </button>
                    {% elif order.status == 'in_progress' %}
                        <button class="btn btn-primary" onclick="updateOrderStatus({{ order.id }}, 'delivered')">
                            Mark as Delivered
                        </button>
                    {% elif order.status == 'delivered' %}
                        <p style="color: var(--gold); margin: 0;">Waiting for buyer confirmation...</p>
                    {% endif %}
                </div>
            </div>
            {% endif %}

            <!-- Order Actions for Buyer -->
            {% if user == order.buyer and order.status == 'delivered' %}
            <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid var(--light-gray);">
                <p style="color: #64748b; margin: 0 0 10px 0;">Actions:</p>
                <button class="btn btn-primary" onclick="updateOrderStatus({{ order.id }}, 'completed')">
                    Confirm Completion
                </button>
            </div>
            {% endif %}
        </div>

        <!-- Messaging System -->
        <div class="glass-panel">
            <h3 style="margin-bottom: 20px;">Messages</h3>
            
            <!-- Messages Container -->
            <div id="messages-container" style="max-height: 400px; overflow-y: auto; margin-bottom: 20px; padding: 15px; background: #f8fafc; border-radius: 8px;">
                {% if order_messages %}
                    {% for msg in order_messages %}
                    <div class="message-bubble {% if msg.sender == user %}own-message{% else %}other-message{% endif %}" 
                         style="margin-bottom: 15px; {% if msg.sender == user %}text-align: right;{% endif %}">
                        <div style="display: inline-block; max-width: 70%; padding: 12px 16px; border-radius: 12px; 
                                    {% if msg.sender == user %}background: var(--gold); color: var(--deep-blue);{% else %}background: white; color: var(--deep-blue); box-shadow: 0 2px 4px rgba(0,0,0,0.1);{% endif %}">
                            <p style="font-size: 0.85rem; font-weight: 600; margin: 0 0 5px 0; opacity: 0.8;">
                                {{ msg.sender.username }}
                            </p>
                            <p style="margin: 0;">{{ msg.message }}</p>
                            <p style="font-size: 0.75rem; margin: 5px 0 0 0; opacity: 0.7;">
                                {{ msg.created_at|date:"M d, g:i A" }}
                            </p>
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <p style="text-align: center; color: #64748b; margin: 20px 0;">No messages yet. Start the conversation!</p>
                {% endif %}
            </div>

            <!-- Message Input -->
            <form id="message-form" onsubmit="sendMessage(event, {{ order.id }})">
                <div style="display: flex; gap: 10px;">
                    <input 
                        type="text" 
                        id="message-input" 
                        class="search-input" 
                        placeholder="Type your message..."
                        required
                        style="flex: 1;"
                    >
                    <button type="submit" class="btn btn-primary">Send</button>
                </div>
            </form>
        </div>

        <div style="text-align: center; margin-top: 20px;">
            <a href="{% url 'dashboard' %}" style="color: var(--gold); font-weight: 600; text-decoration: none;">
                ‚Üê Back to Dashboard
            </a>
        </div>
    </div>
</div>

<script>
// Update order status
async function updateOrderStatus(orderId, newStatus) {
    if (!confirm('Are you sure you want to update the order status?')) {
        return;
    }

    try {
        const csrftoken = getCookie('csrftoken');
        const response = await fetch(`/api/orders/${orderId}/status/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrftoken
            },
            body: JSON.stringify({ status: newStatus })
        });

        const data = await response.json();

        if (data.success) {
            alert(data.message);
            location.reload();
        } else {
            alert('Error: ' + data.error);
        }
    } catch (error) {
        console.error('Error updating order:', error);
        alert('Failed to update order status');
    }
}

// Send message
async function sendMessage(event, orderId) {
    event.preventDefault();
    
    const input = document.getElementById('message-input');
    const message = input.value.trim();
    
    if (!message) return;

    try {
        const csrftoken = getCookie('csrftoken');
        const response = await fetch(`/api/orders/${orderId}/send-message/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrftoken
            },
            body: JSON.stringify({ message: message })
        });

        const data = await response.json();

        if (data.success) {
            // Add message to container
            const container = document.getElementById('messages-container');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message-bubble own-message';
            messageDiv.style.cssText = 'margin-bottom: 15px; text-align: right;';
            messageDiv.innerHTML = `
                <div style="display: inline-block; max-width: 70%; padding: 12px 16px; border-radius: 12px; 
                            background: var(--gold); color: var(--deep-blue);">
                    <p style="font-size: 0.85rem; font-weight: 600; margin: 0 0 5px 0; opacity: 0.8;">
                        ${data.sender}
                    </p>
                    <p style="margin: 0;">${data.message}</p>
                    <p style="font-size: 0.75rem; margin: 5px 0 0 0; opacity: 0.7;">
                        Just now
                    </p>
                </div>
            `;
            container.appendChild(messageDiv);
            container.scrollTop = container.scrollHeight;
            
            // Clear input
            input.value = '';
        } else {
            alert('Error: ' + data.error);
        }
    } catch (error) {
        console.error('Error sending message:', error);
        alert('Failed to send message');
    }
}

// Get CSRF token
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Auto-scroll to bottom
document.addEventListener('DOMContentLoaded', () => {
    const container = document.getElementById('messages-container');
    container.scrollTop = container.scrollHeight;
});
</script>
{% endblock %}
